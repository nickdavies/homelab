# Image bootstrap and upgrades

## Upgrades

Upgrades are done using the `upgrade.sh` script. Machines should always be done one at a time.

For example if we want to upgrade to version `v1.10.4` first run:
```
./remote-image-gen.sh customizations.yaml "v1.10.4"
```

This will generate you a id if you don't have it already (eg `2babf6fe3a996452becf9635e9b9d9a380e8a7ece5190b17db365dae427ed807`).

Then you can pass this into `upgrade.sh` for example:
```
./upgrade.sh 2babf6fe3a996452becf9635e9b9d9a380e8a7ece5190b17db365dae427ed807 "v1.10.4" 192.168.254.11
```

## Resetting

To reset a machine run:
```
talosctl reset -n k8s-node-1 --reboot --graceful
```

## Booting / Bootstrapping

Booting is done via:
 - DHCP points to PXE boot `<NAS_IP>/ipxe.efi`
 - `<NAS_IP/ipxe.efi` boots iPXE
 - iPXE has an embedded script that points to `<NAS_IP>/talos.ipxe`
 - `<NAS_IP>/talos.ipxe` is generated by downloading the PXE config returned by `image_build/remote-image-gen.sh` (which should be copied to the NAS)

Note: This does NOT apply to the Pi!

Note: BIOS/UFI should be set to boot disk then network.

I followed https://mstephenson.eu/pxe-boot-talos-with-matchbox/ for a lot of this instructions as well as https://ipxe.org/howto/chainloading

For now I have simplified the setup there to remove matchbox and instead just chainload directly the iPXE script image_factory hosts. This means that machines come up in maintanence mode
rather than fully configured but for now I am happy with that as it gives me an extra step to confirm everything is good before continuing.

### EFI/BIOS

Configure your system to boot from disk first and then network. This is so that once a machine is setup it will boot from disk and ignore the network. Then if you reset the machine with `talosctl reset` it will come back and boot from the network as the disk will be empty.

### DHCP

DHCP is configured in the unifi console. Nothing too special here but it is set specifically for the k8s network only currently. It's set currently to `/ipxe.efi`

### iPXE + NAS

The NAS has TFTP enabled:

> I created a shared folder called tftp, then enabled the TFTP service by going to `Control Panel -> File Services -> Advanced -> TFTP`, checking the `Enable TFTP service` box, selecting the `tftp` folder I just created and then clicking Apply.

Building the image for iPXE should be a once-off operation unless I want to upgrade the version if iPXE used. But is done by first getting ipxe source:
```
git clone https://github.com/ipxe/ipxe.git
```

Then creating a file inside ipxe repo (eg `src/boot.ipxe`):
```
export NAS_IP="<NAS_IP>"
cat <<EOF > boot.ipxe
#!ipxe
dhcp
chain tftp://${NAS_IP}/talos.ipxe || shell
EOF
```

#### Enabling HTTPS

Before building I needed to enable HTTPS by editing `src/config/general.h`
```
-#undef DOWNLOAD_PROTO_HTTPS    /* Secure Hypertext Transfer Protocol */
+#define        DOWNLOAD_PROTO_HTTPS    /* Secure Hypertext Transfer Protocol */
```

#### Build IPXE

building ipxe with (inside `ipxe/src` where the `Makefile` and your `boot.ipxe` file is). You can build one or the other or both:
```
make bin/undionly.kpxe EMBED=boot.ipxe
make bin-x86_64-efi/ipxe.efi EMBED=boot.ipxe
```

I am using efi only because my boxes all have uefi as their boot method.

### talos.ipxe

This file needs to live at the top of the tftp directory called `talos.ipxe` (or whatever the name is in the previous step)
and can be built by running:

```
./remote-image-gen.sh customizations.yaml "v1.10.4"
```

Then this will give you some urls. One of them is the pxe config. If you curl this you will get the config you need to upload to the NAS

This file should let the machine boot and then sit in maintenance mode ready for install.
