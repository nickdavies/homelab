apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: &app homeassistant
spec:
  replicas: 1
  selector:
    matchLabels:
      app: *app
  serviceName: "homeassistant"
  template:
    metadata:
      labels:
        app: *app
      annotations:
        reloader.stakater.com/auto: "true"
        configmap.reloader.stakater.com/reload: "home-assistant-static-config-version"
        kubectl.kubernetes.io/default-container: app
        k8s.v1.cni.cncf.io/networks: |
          [
            {"name": "multus-iot", "namespace": "network", "ips": ["192.168.20.9/24"]},
            {"name": "multus-not", "namespace": "network", "ips": ["192.168.30.9/24"]}
          ]
    spec:
      terminationGracePeriodSeconds: 30
      initContainers:
        - name: init-db
          image: ghcr.io/home-operations/postgres-init:18.1.0
          envFrom:
            - secretRef:
                name: home-assistant-secret
      volumes:
      - name: overlayfs-config
        configMap:
          name: overlayfs-config
      - name: static-config-vol
        persistentVolumeClaim:
          claimName: hass-static-configs
      - name: dynamic-config-vol
        configMap:
          name: hass-dynamic-configs
          items:
            - key: zigbee_all_lights.yaml
              path: dynamic/lovelace/generated/all_lights.yaml
      - name: secret-config-vol
        secret:
          secretName: hass-secret-configs
          items:
            - key: secrets.yaml
              path: secrets/secrets.yaml
      - name: rw-data-vol
        persistentVolumeClaim:
          claimName: homeassistant-rw
      containers:
      - name: overlay-manager
        image: nickdavies1/kube-overlayfs:main
        securityContext:
          privileged: true
          allowPrivilegeEscalation: true
          runAsNonRoot: false
          capabilities:
            add: ["SYS_ADMIN"]
            drop: ["ALL"]
          seccompProfile:
            type: RuntimeDefault
        command:
         - /app/overlay-mount
         - --config
         - /mnt/overlayfs-config/overlayfs-config.toml
        volumeMounts:
        - name: overlayfs-config
          mountPath: /mnt/overlayfs-config
          readOnly: true
        - name: static-config-vol
          mountPath: /mnt/static-config
          readOnly: true
        - name: dynamic-config-vol
          mountPath: /mnt/dynamic-config
          readOnly: true
        - name: secret-config-vol
          mountPath: /mnt/secret-config
          readOnly: true
        - name: rw-data-vol
          mountPath: /mnt/rw-vol
          mountPropagation: Bidirectional
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - "mountpoint -q /mnt/rw-vol/merged && test -f /mnt/rw-vol/merged/.success-marker"
          initialDelaySeconds: 2
          periodSeconds: 5
          timeoutSeconds: 10
          successThreshold: 1
          failureThreshold: 3
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - "mountpoint -q /mnt/rw-vol/merged"
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
      - name: app
        image: ghcr.io/home-operations/home-assistant:2025.12.5
        livenessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - "test -f /config/.success-marker"
          initialDelaySeconds: 60
          periodSeconds: 30
          failureThreshold: 3
        env:
          - name: TZ
            value: ${TIMEZONE}
        command:
        - /usr/bin/catatonit
        - --
        - /bin/bash
        - -c
        - |
          function finish {
            echo "exciting gracefully . . ."
            kill -TERM "$child" 2>/dev/null
            exit 0
          }
          trap finish SIGHUP SIGINT SIGQUIT SIGTERM

          while [ ! -f /config/.success-marker ]; do
            echo "Waiting for mount..."
            sleep 2 &
            child=$!
            wait $child
          done

          # Validation checks before starting Home Assistant
          echo "Running pre-startup validation checks..."

          # Check if configuration.yaml exists in the merged view (required)
          if [ ! -f /config/configuration.yaml ]; then
            echo "ERROR: configuration.yaml not found in /config/"
            echo "Home Assistant requires configuration.yaml to be present"
            echo "Check that the static configs are properly mounted and contain configuration.yaml"
            exit 1
          fi

          echo "Pre-startup validation passed"

          mkdir /venv
          export VENV_FOLDER="/venv"
          exec /entrypoint.sh "$@"
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: false
          runAsUser: 0
          capabilities:
            add:
              - NET_ADMIN
              - NET_RAW
            drop: ["ALL"]
          seccompProfile:
            type: RuntimeDefault
        volumeMounts:
        - name: rw-data-vol
          mountPath: /config
          subPath: merged
          mountPropagation: HostToContainer
